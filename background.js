import{loadConfig as e}from"./config.js";let a=null;(async()=>{a=await e(),console.log("Configuration loaded:",a)})(),chrome.runtime.onMessage.addListener(((o,t,n)=>{if("START_INJECTION"===o.action)return async function(o){a||(a=await e());if(console.log("Starting Injection Process..."),!a.supabaseUrl||!a.supabaseKey)throw new Error("Configuration Error: Missing Supabase URL or key in runtime config.");const t=await async function(e){if(!e)throw new Error("License key is required.");const o=await async function(){const e=await chrome.storage.local.get(["hwid"]);if(e.hwid)return e.hwid;const a=crypto.randomUUID();return await chrome.storage.local.set({hwid:a}),a}();console.log("Checking license for Device:",o);const t=`${a.supabaseUrl}/rest/v1/rpc/claim_license`;let n;try{n=await fetch(t,{method:"POST",headers:{apikey:a.supabaseKey,Authorization:`Bearer ${a.supabaseKey}`,"Content-Type":"application/json"},body:JSON.stringify({p_license_key:e,p_hardware_id:o,p_include_account:!0})})}catch(e){throw new Error(`License validation failed: ${e.message}`)}const i=await n.text();let s=null;if(i)try{s=JSON.parse(i)}catch(e){s=null}if(!n.ok){const e=s&&s.message?s.message:i||"License validation failed.";throw new Error(e)}if(!s||!s.success){const e=s&&s.message?s.message:"Invalid, Expired, or Device-Locked License Key.";throw new Error(e)}"newly_claimed"===s.status?console.log("License claimed and locked to this device."):console.log("License valid and belongs to this device.");if(!s.account||!s.account.cookie_data)throw new Error("No valid accounts available in the database.");return s.account}(o);if(!t||!t.cookie_data)throw new Error("No valid accounts available in the database.");await async function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}if(!Array.isArray(e))throw new Error("Invalid cookie format");for(const o of e){let e=o.domain||a.baseDomain;const t={url:a.targetDomain,name:o.name,value:o.value,domain:e,path:o.path||"/",secure:!0,httpOnly:o.httpOnly||!1,sameSite:"no_restriction"};try{await chrome.cookies.set(t)}catch(e){}}}(t.cookie_data),async function(){const e=await chrome.tabs.query({active:!0,currentWindow:!0});e.length>0&&chrome.tabs.reload(e[0].id)}()}(o.licenseKey).then((()=>n({success:!0}))).catch((e=>n({success:!1,message:e.message}))),!0}));